<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Money Maze: The Path to Freedom</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #000;
            color: white;
            margin: 0;
            overflow: hidden;
        }
        #game-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }
        /* HUD */
        #hud {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            padding: 1rem;
            z-index: 10;
            pointer-events: none;
            text-shadow: 0 0 5px rgba(0,0,0,0.7);
        }
        .hud-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
        }
        @media (min-width: 640px) {
            .hud-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        .stat-box {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 0.5rem;
            padding: 0.5rem 0.75rem;
            backdrop-filter: blur(5px);
        }
        .stat-label {
            font-size: 0.75rem;
            font-weight: 600;
            opacity: 0.8;
            text-transform: uppercase;
        }
        .stat-value {
            font-size: 1.25rem;
            font-weight: 700;
        }
        .text-green-glow { color: #4ade80; }
        .text-blue-glow { color: #60a5fa; }
        .text-yellow-glow { color: #facc15; }
        .text-red-glow { color: #f87171; }

        /* Timer & Progress */
        #timer {
            position: fixed;
            top: 1rem;
            right: 1rem;
            background: rgba(0, 0, 0, 0.3);
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 1.5rem;
            font-weight: 700;
            z-index: 10;
        }
        #progress-container {
            position: fixed;
            bottom: 1rem;
            left: 5%;
            width: 90%;
            height: 2.5rem;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 0.5rem;
            z-index: 10;
            padding: 0.5rem;
        }
        #progress-bar {
            width: 0%;
            height: 100%;
            background: linear-gradient(90deg, #4f46e5, #a855f7);
            border-radius: 0.25rem;
            transition: width 0.2s linear;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }
        #progress-bar-text {
            text-shadow: 0 0 3px #000;
        }

        /* Modal */
        #modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            transition: opacity 0.3s;
        }
        .modal-content {
            background: #1f2937;
            border: 1px solid #374151;
            border-radius: 0.75rem;
            padding: 2rem;
            width: 90%;
            max-width: 500px;
            text-align: center;
            box-shadow: 0 0 30px rgba(79, 70, 229, 0.5);
        }

        /* Touch Controls */
        #touch-controls {
            position: fixed;
            inset: 0;
            z-index: 9;
            display: flex;
        }
        #touch-left {
            width: 50%;
            height: 100%;
        }
        #touch-right {
            width: 50%;
            height: 100%;
        }
    </style>
</head>
<body>

    <!-- 3D Game Canvas -->
    <div id="game-container"></div>

    <!-- HUD -->
    <div id="hud">
        <div class="hud-grid">
            <div class="stat-box">
                <div class="stat-label">Cash</div>
                <div id="cash-value" class="stat-value text-green-glow">$500</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Savings</div>
                <div id="savings-value" class="stat-value text-blue-glow">$0</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Investments</div>
                <div id="invest-value" class="stat-value text-yellow-glow">$0</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Debt</div>
                <div id="debt-value" class="stat-value text-red-glow">$0</div>
            </div>
        </div>
    </div>

    <!-- Timer -->
    <div id="timer">03:00</div>

    <!-- Progress Bar -->
    <div id="progress-container">
        <div id="progress-bar">
            <span id="progress-bar-text">0%</span>
        </div>
    </div>

    <!-- Modal -->
    <div id="modal-overlay">
        <div id="modal-content">
            <!-- Content Injected by JS -->
        </div>
    </div>

    <!-- Touch Controls -->
    <div id="touch-controls">
        <div id="touch-left"></div>
        <div id="touch-right"></div>
    </div>

    <script type="module">
        // --- 3D Scene Setup ---
        let scene, camera, renderer, player, clock;
        let ground, goalGate;
        const trackObjects = []; // To store coins, traps, zones
        const LANE_WIDTH = 3;
        const LANES = [-LANE_WIDTH, 0, LANE_WIDTH];
        const GOAL_DISTANCE = 3000;
        const GAME_DURATION = 180; // 3 minutes

        // --- Game State ---
        const gameState = {
            running: false,
            cash: 500,
            savings: 0,
            investments: 0,
            debt: 0,
            timeLeft: GAME_DURATION,
            distance: 0,
            playerSpeed: 15,
            playerTargetLane: 1, // 0: left, 1: center, 2: right
            speedBoost: 0,
            eventTimer: 0,
            nextEventTime: 20, // First event after 20s
        };

        // --- DOM Elements ---
        const dom = {
            cash: document.getElementById('cash-value'),
            savings: document.getElementById('savings-value'),
            invest: document.getElementById('invest-value'),
            debt: document.getElementById('debt-value'),
            timer: document.getElementById('timer'),
            progressBar: document.getElementById('progress-bar'),
            progressBarText: document.getElementById('progress-bar-text'),
            modalOverlay: document.getElementById('modal-overlay'),
            modalContent: document.getElementById('modal-content'),
            touchLeft: document.getElementById('touch-left'),
            touchRight: document.getElementById('touch-right'),
        };
        
        // --- Helper Functions ---
        const formatCurrency = (val) => `$${Math.floor(val).toLocaleString()}`;
        
        const updateHUD = () => {
            dom.cash.textContent = formatCurrency(gameState.cash);
            dom.savings.textContent = formatCurrency(gameState.savings);
            dom.invest.textContent = formatCurrency(gameState.investments);
            dom.debt.textContent = formatCurrency(gameState.debt);

            // Timer
            const minutes = Math.floor(gameState.timeLeft / 60);
            const seconds = Math.floor(gameState.timeLeft % 60);
            dom.timer.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            // Progress Bar
            const progress = Math.min(100, (gameState.distance / GOAL_DISTANCE) * 100);
            dom.progressBar.style.width = `${progress}%`;
            dom.progressBarText.textContent = `Path to Freedom: ${Math.floor(progress)}%`;
        };

        const showModal = (title, message, buttons) => {
            gameState.running = false; // Pause game
            let buttonHtml = buttons.map(btn => 
                `<button class="w-full ${btn.class} text-white font-bold py-3 px-4 rounded-lg mt-4" onclick="${btn.action}">${btn.text}</button>`
            ).join('');
            
            dom.modalContent.innerHTML = `
                <h2 class="text-3xl font-bold mb-4 ${title === 'You Win!' ? 'text-green-400' : title === 'Game Over!' ? 'text-red-400' : 'text-yellow-400'}">${title}</h2>
                <p class="text-lg text-gray-300 mb-6">${message}</p>
                <div class="mt-4">${buttonHtml}</div>
            `;
            dom.modalOverlay.style.display = 'flex';
        };
        
        // Make modal actions globally accessible
        window.startGame = () => {
            gameState.running = true;
            dom.modalOverlay.style.display = 'none';
        };
        
        window.restartGame = () => {
            location.reload();
        };

        window.handleEventChoice = (choice) => {
            const event = lastRandomEvent;
            if (event.choices[choice].action) {
                event.choices[choice].action();
            }
            dom.modalOverlay.style.display = 'none';
            gameState.running = true;
        };

        // --- 3D Game Object Creation ---
        
        // Ground
        function createGround() {
            const material = new THREE.MeshBasicMaterial({ 
                color: 0x1f2937, // Dark blue-gray
                wireframe: true,
                transparent: true,
                opacity: 0.5
            });
            const geometry = new THREE.PlaneGeometry(LANE_WIDTH * 3.5, GOAL_DISTANCE, 10, 300);
            ground = new THREE.Mesh(geometry, material);
            ground.rotation.x = -Math.PI / 2;
            ground.position.z = -GOAL_DISTANCE / 2;
            ground.position.y = -0.5; // Player sphere is radius 0.5
            scene.add(ground);
        }
        
        // Player
        function createPlayer() {
            const geometry = new THREE.SphereGeometry(0.5, 32, 32);
            const material = new THREE.MeshBasicMaterial({ color: 0xffffff });
            player = new THREE.Mesh(geometry, material);
            player.position.y = 0; // Sits on the ground plane
            player.position.z = 5; // Start just before camera
            player.position.x = LANES[gameState.playerTargetLane];
            scene.add(player);
        }
        
        // Goal Gate
        function createGoal() {
            const geometry = new THREE.BoxGeometry(LANE_WIDTH * 5, 10, 1);
            const material = new THREE.MeshBasicMaterial({ color: 0x4f46e5, wireframe: true });
            goalGate = new THREE.Mesh(geometry, material);
            goalGate.position.z = -GOAL_DISTANCE;
            goalGate.position.y = 5;
            scene.add(goalGate);
        }

        // Create all track objects at once
        function populateTrack() {
            const coinGeo = new THREE.CylinderGeometry(0.3, 0.3, 0.1, 16);
            const coinMat = new THREE.MeshBasicMaterial({ color: 0xfacc15 }); // Yellow
            
            const trapGeo = new THREE.BoxGeometry(LANE_WIDTH * 0.8, 0.5, 0.5);
            const trapMat = new THREE.MeshBasicMaterial({ color: 0xf87171 }); // Red
            
            const zoneGeo = new THREE.PlaneGeometry(LANE_WIDTH, 10);
            const bankMat = new THREE.MeshBasicMaterial({ color: 0x60a5fa, transparent: true, opacity: 0.5 }); // Blue
            const investMat = new THREE.MeshBasicMaterial({ color: 0x4ade80, transparent: true, opacity: 0.5 }); // Green
            const spendMat = new THREE.MeshBasicMaterial({ color: 0xf472b6, transparent: true, opacity: 0.5 }); // Pink

            for (let z = -10; z > -GOAL_DISTANCE; z -= 10) {
                const lane = Math.floor(Math.random() * 3); // 0, 1, or 2
                const objectType = Math.random();
                
                let obj;
                if (objectType < 0.5) { // 50% chance of coin
                    obj = new THREE.Mesh(coinGeo, coinMat);
                    obj.userData = { type: 'coin', value: 10, collected: false };
                    obj.rotation.x = Math.PI / 2;
                } else if (objectType < 0.65) { // 15% chance of trap
                    obj = new THREE.Mesh(trapGeo, trapMat);
                    obj.userData = { type: 'trap', value: 100, collected: false };
                } else if (objectType < 0.8) { // 15% chance of bank zone
                    obj = new THREE.Mesh(zoneGeo, bankMat);
                    obj.rotation.x = -Math.PI / 2;
                    obj.position.y = -0.4; // Just on ground
                    obj.userData = { type: 'zone', zone: 'bank', collected: false };
                } else if (objectType < 0.9) { // 10% chance of invest zone
                    obj = new THREE.Mesh(zoneGeo, investMat);
                    obj.rotation.x = -Math.PI / 2;
                    obj.position.y = -0.4;
                    obj.userData = { type: 'zone', zone: 'invest', collected: false };
                } else { // 10% chance of spend zone
                    obj = new THREE.Mesh(zoneGeo, spendMat);
                    obj.rotation.x = -Math.PI / 2;
                    obj.position.y = -0.4;
                    obj.userData = { type: 'zone', zone: 'spend', collected: false };
                }
                
                obj.position.x = LANES[lane];
                obj.position.z = z;
                scene.add(obj);
                trackObjects.push(obj);
            }
        }

        // --- Game Logic ---
        function init() {
            // Scene
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0a0a2a); // Dark space blue
            scene.fog = new THREE.Fog(0x0a0a2a, 50, 150);

            // Clock
            clock = new THREE.Clock();

            // Camera
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 5, 10); // Positioned behind and above player
            
            // Renderer
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.getElementById('game-container').appendChild(renderer.domElement);

            // Lights
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(ambientLight);
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(0, 10, -10);
            scene.add(directionalLight);
            
            // Create Game Objects
            createPlayer();
            createGround();
            createGoal();
            populateTrack();
            
            // Event Listeners
            window.addEventListener('resize', onWindowResize);
            document.addEventListener('keydown', onKeyDown);
            dom.touchLeft.addEventListener('touchstart', (e) => { e.preventDefault(); movePlayer(-1); });
            dom.touchRight.addEventListener('touchstart', (e) => { e.preventDefault(); movePlayer(1); });

            // Show Start Modal
            showModal(
                'Money Maze',
                'Welcome to The Path to Freedom! Collect coins, avoid debt traps, and make smart financial choices to reach the goal before time runs out. Use Arrow Keys or Touch to move.',
                [{ text: 'Start Game', action: 'startGame()', class: 'bg-indigo-600 hover:bg-indigo-700' }]
            );
            
            // Start Loop
            window.onload = animate;
        }

        function movePlayer(direction) { // -1 for left, 1 for right
            if (!gameState.running) return;
            let newLane = gameState.playerTargetLane + direction;
            gameState.playerTargetLane = Math.max(0, Math.min(2, newLane)); // Clamp between 0 and 2
        }

        function onKeyDown(event) {
            if (event.key === 'ArrowLeft') {
                movePlayer(-1);
            } else if (event.key === 'ArrowRight') {
                movePlayer(1);
            }
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }
        
        // --- Collision & Game Mechanics ---
        function checkCollisions() {
            const playerBox = new THREE.Box3().setFromObject(player);
            
            for (let i = trackObjects.length - 1; i >= 0; i--) {
                const obj = trackObjects[i];
                if (obj.userData.collected) continue;

                // Simple distance check first
                if (Math.abs(player.position.z - obj.position.z) > 5) continue; 
                
                const objBox = new THREE.Box3().setFromObject(obj);
                
                if (playerBox.intersectsBox(objBox)) {
                    obj.userData.collected = true;
                    
                    switch (obj.userData.type) {
                        case 'coin':
                            gameState.cash += obj.userData.value;
                            scene.remove(obj);
                            trackObjects.splice(i, 1);
                            break;
                        case 'trap':
                            gameState.debt += obj.userData.value;
                            gameState.cash -= obj.userData.value / 2; // Also lose some cash
                            obj.material.color.set(0x550000); // Dim it
                            break;
                        case 'zone':
                            handleZone(obj.userData.zone);
                            obj.material.opacity = 0.1; // Fade it
                            break;
                    }
                }
            }
        }
        
        function handleZone(zoneType) {
            switch (zoneType) {
                case 'bank':
                    let toSave = Math.floor(gameState.cash * 0.1);
                    if (toSave > 0) {
                        gameState.cash -= toSave;
                        gameState.savings += toSave;
                    }
                    break;
                case 'invest':
                    let toInvest = Math.floor(gameState.cash * 0.1);
                    if (toInvest > 0) {
                        gameState.cash -= toInvest;
                        gameState.investments += toInvest;
                    }
                    break;
                case 'spend':
                    let toSpend = 50;
                    if (gameState.cash >= toSpend) {
                        gameState.cash -= toSpend;
                        gameState.speedBoost = 5; // Boost for 5 seconds
                    }
                    break;
            }
        }

        let lastRandomEvent = null;
        const randomEvents = [
            {
                title: 'Medical Emergency!',
                message: 'You have an unexpected medical bill.',
                choices: [
                    { text: 'Pay with Cash ($500)', class: 'bg-red-600', action: () => { gameState.cash -= 500; } },
                    { text: 'Pay from Savings ($500)', class: 'bg-red-600', action: () => { gameState.savings -= 500; } },
                    { text: 'Take on Debt ($500)', class: 'bg-red-600', action: () => { gameState.debt += 500; } }
                ]
            },
            {
                title: 'Job Promotion!',
                message: 'Great work! You received a $1000 bonus.',
                choices: [
                    { text: 'Awesome!', class: 'bg-green-600', action: () => { gameState.cash += 1000; } }
                ]
            },
            {
                title: 'Stock Market Soars!',
                message: 'Your investments have grown by 20%!',
                choices: [
                    { text: 'Hooray!', class: 'bg-green-600', action: () => { gameState.investments *= 1.2; } }
                ]
            },
            {
                title: 'Scam Alert!',
                message: 'A "Too Good To Be True" offer cost you $300.',
                choices: [
                    { text: 'Ouch!', class: 'bg-red-600', action: () => { gameState.cash -= 300; } }
                ]
            }
        ];

        function triggerRandomEvent() {
            const event = randomEvents[Math.floor(Math.random() * randomEvents.length)];
            lastRandomEvent = event;
            
            // Filter choices based on ability to pay
            let finalChoices = [];
            if (event.title === 'Medical Emergency!') {
                if (gameState.cash >= 500) finalChoices.push(event.choices[0]);
                if (gameState.savings >= 500) finalChoices.push(event.choices[1]);
                if (finalChoices.length === 0) finalChoices.push(event.choices[2]); // Must take on debt
            } else {
                finalChoices = event.choices;
            }
            
            const buttons = finalChoices.map((c, i) => ({ ...c, action: `handleEventChoice(${i})` }));
            
            showModal(event.title, event.message, buttons);
        }

        function checkGameStatus(delta) {
            // Update timers
            gameState.timeLeft -= delta;
            gameState.eventTimer += delta;
            if (gameState.speedBoost > 0) gameState.speedBoost -= delta;

            // Trigger random event
            if (gameState.eventTimer > gameState.nextEventTime) {
                triggerRandomEvent();
                gameState.eventTimer = 0;
                gameState.nextEventTime = 20 + Math.random() * 10; // Next event in 20-30s
            }

            // Passive income/loss
            gameState.investments += (gameState.investments * 0.0001); // Slow growth
            gameState.savings += (gameState.savings * 0.00005); // Slower growth
            if (gameState.debt > 0) {
                gameState.debt += (gameState.debt * 0.0002); // Debt grows
            }
            
            // Check win condition
            if (player.position.z <= -GOAL_DISTANCE) {
                gameState.running = false;
                let finalScore = gameState.cash + gameState.savings + gameState.investments - gameState.debt;
                showModal(
                    'You Win!',
                    `You reached the Financial Freedom Gate! Your final net worth is ${formatCurrency(finalScore)}.`,
                    [{ text: 'Play Again', action: 'restartGame()', class: 'bg-indigo-600 hover:bg-indigo-700' }]
                );
            }
            
            // Check lose condition
            if (gameState.timeLeft <= 0) {
                gameState.running = false;
                showModal(
                    'Game Over!',
                    'Time ran out! Building financial freedom is a marathon, not a sprint. Try again!',
                    [{ text: 'Restart Game', action: 'restartGame()', class: 'bg-gray-600 hover:bg-gray-700' }]
                );
            }
            
            // Handle debt game over
            if (gameState.debt > 5000) {
                 gameState.running = false;
                showModal(
                    'Game Over!',
                    'Your debt became unmanageable. Avoid those red traps next time!',
                    [{ text: 'Restart Game', action: 'restartGame()', class: 'bg-gray-600 hover:bg-gray-700' }]
                );
            }
        }

        // --- Animation Loop ---
        function animate() {
            requestAnimationFrame(animate);
            
            const delta = clock.getDelta();
            
            if (gameState.running) {
                // Determine speed
                let currentSpeed = gameState.playerSpeed;
                if (gameState.speedBoost > 0) {
                    currentSpeed *= 1.5; // 50% speed boost
                }
                
                // Move player forward
                player.position.z -= currentSpeed * delta;
                gameState.distance = -player.position.z;
                
                // Smooth lane change (Lerp)
                const targetX = LANES[gameState.playerTargetLane];
                player.position.x = THREE.MathUtils.lerp(player.position.x, targetX, 0.1);
                
                // Camera follows player
                camera.position.z = player.position.z + 10;
                camera.position.y = THREE.MathUtils.lerp(camera.position.y, 5, 0.05);
                camera.position.x = THREE.MathUtils.lerp(camera.position.x, player.position.x, 0.1);
                camera.lookAt(player.position.x, player.position.y, player.position.z - 5);
                
                // Spin coins
                trackObjects.forEach(obj => {
                    if (obj.userData.type === 'coin') {
                        obj.rotation.z += delta * 5;
                    }
                });
                
                // Check for collisions
                checkCollisions();
                
                // Check game status
                checkGameStatus(delta);
            }
            
            // Always update HUD and render
            updateHUD();
            renderer.render(scene, camera);
        }

        // Start the game
        init();
    </script>
</body>
</html>
